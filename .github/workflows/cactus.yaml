on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - crates/cactus/**
      - crates/cactus-sys/**
  pull_request:
    paths:
      - crates/cactus/**
      - crates/cactus-sys/**

jobs:
  cactus:
    runs-on: depot-ubuntu-24.04-arm-8
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: ./.github/actions/rust_install
        with:
          platform: linux
      - run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libcurl4-openssl-dev libclang-dev
      - run: |
          pip3 install --break-system-packages huggingface-hub
          pip3 install --break-system-packages -e vendor/cactus/python/ --no-deps
      - uses: actions/cache@v4
        with:
          path: vendor/cactus/weights/
          key: cactus-models-arm-v1
      - run: |
          cactus download google/gemma-3-270m-it
          cactus download UsefulSensors/moonshine-base
      - run: cargo test -p cactus --test vad
      - run: cargo test -p cactus --test llm -- --ignored --nocapture
        env:
          CACTUS_LLM_MODEL: ${{ github.workspace }}/vendor/cactus/weights/gemma-3-270m-it
      - run: cargo test -p cactus --test stt -- --ignored --nocapture
        env:
          CACTUS_STT_MODEL: ${{ github.workspace }}/vendor/cactus/weights/moonshine-base
